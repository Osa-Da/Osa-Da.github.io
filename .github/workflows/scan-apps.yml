name: Scan Apps on Push to Main

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/**'           # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞–ø–∫–∏ apps
      - '!apps/**.tmp'      # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
      - '!apps/**.bak'
  
  # –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  workflow_dispatch:
    inputs:
      force:
        description: '–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ'
        required: false
        default: 'false'

jobs:
  scan-apps:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –¥–µ—Ç–µ–∫—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Scan HTML files in apps folder
      run: |
        python3 << 'EOF'
import json
import os
import re
import html
from datetime import datetime
from pathlib import Path
import sys

def extract_metadata(file_path):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ HTML —Ñ–∞–π–ª–∞"""
    try:
        with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read()
        
        # –ò—â–µ–º title –≤ head –∏–ª–∏ body
        title_match = re.search(r'<title>(.*?)</title>', content, re.IGNORECASE)
        if not title_match:
            # –ò—â–µ–º h1 –µ—Å–ª–∏ –Ω–µ—Ç title
            title_match = re.search(r'<h1[^>]*>(.*?)</h1>', content, re.IGNORECASE)
        
        title = html.unescape(title_match.group(1).strip()) if title_match else Path(file_path).stem
        
        # –ò—â–µ–º version –≤ —Ç–µ–≥–µ html
        version_match = re.search(r'<html[^>]*version=["\']([^"\']+)["\']', content, re.IGNORECASE)
        version = version_match.group(1) if version_match else 'Alpha'
        
        # –ò—â–µ–º description –≤ meta —Ç–µ–≥–∞—Ö
        desc_match = re.search(
            r'<meta\s+(?:name=["\']description["\']\s+content=["\']([^"\']+)["\']|content=["\']([^"\']+)["\']\s+name=["\']description["\'])',
            content, 
            re.IGNORECASE
        )
        
        description = ''
        if desc_match:
            description = html.unescape(desc_match.group(1) or desc_match.group(2) or '')
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        stat = file_path.stat()
        last_modified = datetime.fromtimestamp(stat.st_mtime).isoformat()
        
        # –°–æ–∑–¥–∞—ë–º ID –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        file_id = Path(file_path).stem
        
        return {
            'id': file_id,
            'url': f"apps/{file_path.name}",
            'title': title,
            'version': version,
            'description': description,
            'last_modified': last_modified,
            'size_kb': round(stat.st_size / 1024, 2)
        }
        
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è {file_path}: {e}", file=sys.stderr)
        return {
            'id': Path(file_path).stem,
            'url': f"apps/{file_path.name}",
            'title': Path(file_path).stem,
            'version': 'Alpha',
            'description': '',
            'last_modified': datetime.now().isoformat(),
            'size_kb': 0
        }

def main():
    apps_dir = Path('apps')
    
    if not apps_dir.exists():
        print("‚ùå –ü–∞–ø–∫–∞ 'apps' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        with open('versions.json', 'w', encoding='utf-8') as f:
            json.dump({
                'last_updated': datetime.now().isoformat(),
                'total_apps': 0,
                'applications': []
            }, f, ensure_ascii=False, indent=2)
        return
    
    applications = []
    
    # –°–∫–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ HTML —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ apps
    html_files = list(apps_dir.glob('*.html')) + list(apps_dir.glob('*.htm'))
    
    if not html_files:
        print("‚ö†Ô∏è –í –ø–∞–ø–∫–µ 'apps' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ HTML —Ñ–∞–π–ª–æ–≤")
    
    for html_file in sorted(html_files, key=lambda x: x.name.lower()):
        metadata = extract_metadata(html_file)
        applications.append(metadata)
        
        # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –ª–æ–≥
        print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ: {metadata['title']} (v{metadata['version']})")
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    applications.sort(key=lambda x: x['title'].lower())
    
    # –°–æ–∑–¥–∞—ë–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
    output = {
        'last_updated': datetime.now().isoformat(),
        'total_apps': len(applications),
        'applications': applications
    }
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ versions.json
    with open('versions.json', 'w', encoding='utf-8') as f:
        json.dump(output, f, ensure_ascii=False, indent=2)
    
    print(f"\nüéâ –°–æ–∑–¥–∞–Ω versions.json —Å {len(applications)} –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏")
    print(f"üìä –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {output['last_updated']}")

if __name__ == '__main__':
    main()
EOF
    
    - name: Check for changes
      id: check-changes
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -q 'versions.json'; then
          echo "versions.json –±—ã–ª –∏–∑–º–µ–Ω—ë–Ω –≤ —ç—Ç–æ–º –∫–æ–º–º–∏—Ç–µ"
          echo "skip_commit=true" >> $GITHUB_OUTPUT
        else
          echo "skip_commit=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.check-changes.outputs.skip_commit == 'false'
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ versions.json
        if [[ -n $(git status --porcelain versions.json) ]]; then
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add versions.json
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
          CHANGED_APPS=$(python3 -c "
import json
with open('versions.json', 'r') as f:
    data = json.load(f)
apps = [app['title'] for app in data['applications']]
print(', '.join(apps[:3]) + ('...' if len(apps) > 3 else ''))
")
          
          git commit -m "ü§ñ Auto-scan: –æ–±–Ω–æ–≤–ª—ë–Ω —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (${CHANGED_APPS})"
          git push
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
        else
          echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        fi
